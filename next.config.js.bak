/** @type {import('next').NextConfig} */
const fs = require('fs');
const path = require('path');

// #region agent log
// Instrumentation: Check file existence and permissions before webpack processes it
const globalsCssPath = path.join(process.cwd(), 'src/app/globals.css');
const logPath = path.join(process.cwd(), '.cursor/debug.log');
const log = (obj) => {
  try {
    fs.appendFileSync(logPath, JSON.stringify(obj) + '\n');
  } catch (e) {}
};
try {
  const stats = fs.statSync(globalsCssPath);
  log({
    location: 'next.config.js:8',
    message: 'File system check - globals.css exists',
    data: {
      path: globalsCssPath,
      exists: true,
      size: stats.size,
      isFile: stats.isFile(),
      readable: fs.constants.R_OK,
      mode: stats.mode.toString(8)
    },
    timestamp: Date.now(),
    sessionId: 'debug-session',
    runId: 'pre-build',
    hypothesisId: 'A'
  });
  
  // Try to read the file to verify accessibility
  const content = fs.readFileSync(globalsCssPath, 'utf8');
  log({
    location: 'next.config.js:28',
    message: 'File read test - globals.css readable',
    data: {
      path: globalsCssPath,
      contentLength: content.length,
      firstChars: content.substring(0, 50),
      readable: true
    },
    timestamp: Date.now(),
    sessionId: 'debug-session',
    runId: 'pre-build',
    hypothesisId: 'B'
  });
} catch (error) {
  log({
    location: 'next.config.js:45',
    message: 'File system check - globals.css ERROR',
    data: {
      path: globalsCssPath,
      error: error.message,
      code: error.code,
      exists: false
    },
    timestamp: Date.now(),
    sessionId: 'debug-session',
    runId: 'pre-build',
    hypothesisId: 'C'
  });
}
// #endregion

const nextConfig = {
  images: {
    domains: [
      'localhost',
      'images.unsplash.com',
    ],
    unoptimized: true,
  },
  trailingSlash: false,
  // Fix: Disable webpack cache to prevent stale synthetic paths from Next.js 14.2.5 bug
  // This is a workaround for the CSS loader trying to read synthetic paths as files
  experimental: {
    // Force webpack to not cache CSS loader resolutions
  },
  webpack: (config, { isServer, webpack }) => {
    // #region agent log
    // Instrumentation: Log webpack configuration and file resolution
    const logPath = path.join(process.cwd(), '.cursor/debug.log');
    const log = (obj) => {
      try {
        fs.appendFileSync(logPath, JSON.stringify(obj) + '\n');
      } catch (e) {}
    };
    log({
      location: 'next.config.js:webpack',
      message: 'Webpack config hook executed',
      data: {
        isServer,
        context: config.context,
        resolveAlias: config.resolve?.alias,
        moduleRulesCount: config.module?.rules?.length
      },
      timestamp: Date.now(),
      sessionId: 'debug-session',
      runId: 'webpack-config',
      hypothesisId: 'D'
    });
    // #endregion
    
    // Fix: Next.js 14.2.5 webpack CSS loader bug
    // The error: webpack tries to read synthetic paths like "globals.css.webpack[javascript/auto]!=!" as files
    // Solution: Disable webpack cache and ensure file system resolver handles paths correctly
    
    // Fix: Next.js 14.2.5 bug - webpack CSS loader tries to read synthetic loader paths as files
    // The synthetic path "globals.css.webpack[javascript/auto]!=!..." is not a real file
    // Solution: Disable cache and patch webpack's file system to handle this
    
    // Disable webpack cache completely to prevent stale synthetic paths
    config.cache = false;
    
    // Patch webpack's file system resolver to handle synthetic paths
    if (!config.resolve) {
      config.resolve = {};
    }
    
    // Fix: Next.js 14.2.5 CSS loader bug - synthetic paths are read as files
    // The error occurs when CSS loader tries to read "globals.css.webpack[javascript/auto]!=!..."
    // Solution: Use a webpack plugin to intercept and fix CSS loader file reads
    
    // Add plugin at compiler level (runs earlier than normalModuleFactory)
    config.plugins.push({
      apply: (compiler) => {
        // #region agent log
        log({
          location: 'next.config.js:webpack-plugin-apply',
          message: 'Webpack plugin apply hook executed',
          data: {
            compilerHooks: Object.keys(compiler.hooks).slice(0, 10)
          },
          timestamp: Date.now(),
          sessionId: 'debug-session',
          runId: 'webpack-plugin-apply',
          hypothesisId: 'G'
        });
        // #endregion
        
        // Hook into compilation to intercept module building
        compiler.hooks.compilation.tap('FixCSSLoader', (compilation) => {
          // Intercept when modules are being built
          compilation.hooks.buildModule.tap('FixCSSLoader', (module) => {
            // Check if this is a CSS module
            if (module.resource && module.resource.includes('globals.css')) {
              // #region agent log
              log({
                location: 'next.config.js:webpack-buildModule',
                message: 'Building CSS module',
                data: {
                  resource: module.resource,
                  type: module.constructor.name
                },
                timestamp: Date.now(),
                sessionId: 'debug-session',
                runId: 'webpack-buildModule',
                hypothesisId: 'H'
              });
              // #endregion
            }
          });
          
          // Intercept when modules fail to build
          compilation.hooks.failedModule.tap('FixCSSLoader', (module, error) => {
            if (module.resource && module.resource.includes('globals.css')) {
              // #region agent log
              log({
                location: 'next.config.js:webpack-failedModule',
                message: 'CSS module build failed',
                data: {
                  resource: module.resource,
                  error: error.message,
                  errorCode: error.code
                },
                timestamp: Date.now(),
                sessionId: 'debug-session',
                runId: 'webpack-failedModule',
                hypothesisId: 'H'
              });
              // #endregion
            }
          });
        });
        
        // Hook into normalModuleFactory at compiler level (runs before compilation)
        compiler.hooks.normalModuleFactory.tap('FixCSSLoader', (nmf) => {
          // #region agent log
          log({
            location: 'next.config.js:webpack-nmf-tap',
            message: 'NormalModuleFactory tapped',
            data: {},
            timestamp: Date.now(),
            sessionId: 'debug-session',
            runId: 'webpack-nmf',
            hypothesisId: 'G'
          });
          // #endregion
          
          // Intercept before resolve
          nmf.hooks.beforeResolve.tap('FixCSSLoader', (data) => {
            if (data && data.request) {
              // Check for CSS files (including globals.css)
              if (data.request.includes('.css') || data.request.includes('globals.css')) {
                // #region agent log
                log({
                  location: 'next.config.js:webpack-css-beforeResolve',
                  message: 'CSS file in beforeResolve',
                  data: {
                    request: data.request.substring(0, 300),
                    context: data.context
                  },
                  timestamp: Date.now(),
                  sessionId: 'debug-session',
                  runId: 'webpack-css-beforeResolve',
                  hypothesisId: 'H'
                });
                // #endregion
              }
              
              // Check for synthetic CSS loader paths and fix them
              if (data.request.includes('globals.css') && data.request.includes('.webpack[')) {
                // #region agent log
                log({
                  location: 'next.config.js:webpack-synthetic-detected',
                  message: 'Synthetic CSS path detected in beforeResolve - FIXING',
                  data: {
                    originalRequest: data.request.substring(0, 300)
                  },
                  timestamp: Date.now(),
                  sessionId: 'debug-session',
                  runId: 'webpack-synthetic-fix',
                  hypothesisId: 'G'
                });
                // #endregion
                
                // Extract the actual file path from the loader chain (last part after !)
                const parts = data.request.split('!');
                const actualPath = parts[parts.length - 1];
                
                // #region agent log
                log({
                  location: 'next.config.js:webpack-extract-path',
                  message: 'Extracted actual file path from synthetic path',
                  data: {
                    actualPath: actualPath,
                    exists: actualPath ? fs.existsSync(actualPath) : false
                  },
                  timestamp: Date.now(),
                  sessionId: 'debug-session',
                  runId: 'webpack-extract',
                  hypothesisId: 'G'
                });
                // #endregion
                
                // CRITICAL FIX: Replace the synthetic path with just the actual file path
                // Webpack will add the loaders back, but this prevents it from trying to read
                // the synthetic path as a file
                if (actualPath && fs.existsSync(actualPath)) {
                  data.request = actualPath;
                  // #region agent log
                  log({
                    location: 'next.config.js:webpack-request-fixed',
                    message: 'Request fixed - replaced synthetic path with actual file',
                    data: {
                      newRequest: data.request
                    },
                    timestamp: Date.now(),
                    sessionId: 'debug-session',
                    runId: 'webpack-fixed',
                    hypothesisId: 'G'
                  });
                  // #endregion
                }
              }
            }
          });
          
          // Intercept after resolve to catch resolved CSS modules
          nmf.hooks.afterResolve.tap('FixCSSLoader', (data) => {
            if (data && data.resource) {
              if (data.resource.includes('globals.css')) {
                // #region agent log
                log({
                  location: 'next.config.js:webpack-css-afterResolve',
                  message: 'CSS file afterResolve',
                  data: {
                    resource: data.resource,
                    context: data.context,
                    request: data.request ? data.request.substring(0, 200) : 'no request'
                  },
                  timestamp: Date.now(),
                  sessionId: 'debug-session',
                  runId: 'webpack-css-afterResolve',
                  hypothesisId: 'H'
                });
                // #endregion
                
                // Verify the file exists
                if (data.resource && !fs.existsSync(data.resource)) {
                  // #region agent log
                  log({
                    location: 'next.config.js:webpack-css-missing',
                    message: 'CSS file NOT found after resolve',
                    data: {
                      resource: data.resource,
                      exists: false
                    },
                    timestamp: Date.now(),
                    sessionId: 'debug-session',
                    runId: 'webpack-css-missing',
                    hypothesisId: 'H'
                  });
                  // #endregion
                }
              }
            }
          });
        });
        
        // Hook into compilation to intercept module building
        compiler.hooks.compilation.tap('FixCSSLoader', (compilation) => {
          compilation.hooks.buildModule.tap('FixCSSLoader', (module) => {
            // Check if this is a CSS module
            if (module.resource && module.resource.includes('globals.css')) {
              // #region agent log
              log({
                location: 'next.config.js:webpack-buildModule',
                message: 'Building CSS module',
                data: {
                  resource: module.resource,
                  type: module.constructor.name
                },
                timestamp: Date.now(),
                sessionId: 'debug-session',
                runId: 'webpack-buildModule',
                hypothesisId: 'H'
              });
              // #endregion
            }
          });
        });
      }
    });
    
    return config;
  },
  async headers() {
    return [
      {
        source: '/llms.txt',
        headers: [
          {
            key: 'Content-Type',
            value: 'text/plain',
          },
        ],
      },
    ];
  },
  async rewrites() {
    return [
      {
        source: '/llms.txt',
        destination: '/api/llms',
      },
    ];
  },
  async redirects() {
    return [
      {
        source: '/blog3',
        destination: '/blogovi',
        permanent: true,
      },
      {
        source: '/blog3/:slug',
        destination: '/blogovi/:slug',
        permanent: true,
      },
    ];
  },
};

module.exports = nextConfig; 